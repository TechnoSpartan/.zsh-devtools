#!/bin/bash

# ASCII logo
cat << "EOF"

                                                      ##  ===++#%%%%%%%
                                            ==:=-:.....:  ...........+%*=
                                     %%+=+ +....:::::::- *:::::::::.:%#:..::=#@
                                  *=-:...:@@:::::::::::- *::::::::::* -.........-=#
                              #+-..:::::::# *::::------+ =:------::-#-:::::::::....:=*
                            %=...:::::::::-@ ----------# =---------* -:::::::::::::...:*
                         %=:+#-.::::::-----* =--------=+%---------+ =-----------------=*
                       #-::::*%#-:---------+@*-----====*#=-------=*+---------------=#
                      +:::::::*%%---------==%@========= +========+ +-=----------=*%
                   %+::::::::--=%%=-----====+@*-======+ +=======+%*=========--=+@
                % #-:::---------=#@*-========% +=====++ ===+=+==##===========*
                  #-::-----------=+ *=======*#                    %#*=====-*@
               %==*%%+------=-=====*%*==**       **=-==----==*%%@     @*++%
              #=:::-+#@*=-==========*      +=-:::--=========--::.:-*#@@
             %=--------*@#+=======+     +:.-=++++++++++++++++++++==:..:#@
            %=-----------=*#====*    +::=+++++++++++++++++++++++++===-:=@
            +---============* *@  #=:-++++++++*#@@@   @    @@@%#*+===+%@
           %================#    *:=++++++%@                     @@@@@
          %  ##+===========#   +:=+++++#%@          *##***#@
          =-=+*#@@#++====+%  %+-+++++#@      %++:.............:==%@
         *========+#   #*@@ @+=++++%@     @*.....::::::............-%@
         +============+*   *-++++*%     +-:::-=========----::::.......-#@        #@
         +==========+++%   +++++#     #=--=+++++++========-----::::.....:#@    %=.=
        #+++++++++++++*   +++++%@   %+--++++++++++++=========----:::::....:%  +:...
        *++++++++++++*   ++++*%    @=-=+*****++++++++++++======-----:::::=# +:.:...+
        ++*%  %%#**++*  #++++*@   %===**********+++++++++++++=====-----== *=.:::...=
       *+++++++=++++*   +++++%   @+=+***************+++++++++++++====+  +-.-::::...:
       *++++++++++++*  #++++#    %==*********************++++++++**   =::---::::...:%
       *++++++++++++#  *+++**   @*=****************************#  #=--====---::::...#
       *++++++++++++%  ++++*    @=+***********************#    ==:=+++====---::::...+@
       #*+++++++++**  #++++#    *=********************#     +-=++++++++===---::::...:@
        ***##%  @#*+% %++++#   @*+***************%    #+===+***+++++++++===---:::....%
        *+*+*+++++++#@ *+++    @*+*************@  **++*********++++++*#@@    %+::....*
        #*++++++++++*@ *++*     *+************#@%****#%%********#%%             +:...=
         *+++++++++++#          #+************ %*******#@%##%%%#***+:+           *:..-#
         **++++++++++*          %************* %********#@#*****++++--            *..-%
         **++++++++++*           #************ @#*******%@#***+++++++-:* @  @      -..%
         #*****++++++*           #************#  #****#%@%****++++++++=:.-=+#%@@   -..=
          *********++*           #************+%   @@@  #*****+++++++++===-::...:  #:.:
          #**********#           %+*************@       @******++++++++====---:..+  =..:
          #**********            %=*************%        #*****+++++++++===----:.-   =:=
          #*********@           @+=************#@        @******++++++++====---:.:
          #********%            *-=********##            @********++++++====---:::#
          ********#            *-=******#                 %*****+++++++++====---:.+
         #*******#            +==*#                         *+*****++++++====---:::
         *******#@                                             *+***++++++====---:.+
         #****#@  %                                              ******+++====---:.:
        %+++*#                                                       *+**++====---::#
       #==+%                                                            #*++*+----:.=
       +*%                                                                  #**+=-:.:#
                                                                                #*+:.+
                                                                                    +*
EOF

echo ""
echo "ğŸ§ª Ejecutando diagnÃ³stico del entorno CodeSpartan..."

# Mostrar ayuda
print_help() {
  echo ""
  echo "Uso:"
  echo "  codespartan-doctor [--help] [--fix]"
  echo ""
  echo "Opciones:"
  echo "  --help   Muestra este mensaje de ayuda"
  echo "  --fix    Instala herramientas faltantes con brew"
  echo ""
}

# ComprobaciÃ³n
check() {
  local name=$1
  local command=$2

  if command -v $command &> /dev/null; then
    echo "âœ… $name detectado: $($command --version | head -n 1)"
  else
    echo "âŒ $name NO encontrado."
    MISSING+=("$name:$command")
  fi
}

# Flags
if [[ "$1" == "--help" ]]; then
  print_help
  exit 0
fi

MISSING=()

check "Zsh" zsh
check "Direnv" direnv
check "Node.js" node
check "NVM" nvm
check "Java (JDK)" java
check "Android SDK" sdkmanager
check "Flutter" flutter
check "Docker" docker
check "Kubectl" kubectl
check "init-env" init-env

# Resultado
if [[ ${#MISSING[@]} -eq 0 ]]; then
  echo ""
  echo "ğŸ‰ Todo estÃ¡ correctamente instalado. Â¡Enhorabuena, espartano!"
else
  echo ""
  echo "âš ï¸  Faltan herramientas:"
  for item in "${MISSING[@]}"; do
    name="${item%%:*}"
    cmd="${item##*:}"
    echo "   - $name ($cmd)"
  done

  if [[ "$1" == "--fix" ]]; then
    echo ""
    echo "ğŸ”§ Intentando instalar con brew..."
    for item in "${MISSING[@]}"; do
      cmd="${item##*:}"
      brew install "$cmd"
    done
    echo "âœ… ReparaciÃ³n completa. Vuelve a ejecutar para verificar."
  else
    echo ""
    echo "ğŸ‘‰ Ejecuta: codespartan-doctor --fix para intentar instalar con brew"
  fi
fi

echo ""
echo "ğŸ§  Tip: Usa comandos como env-node, env-devops o init-env para preparar entornos."